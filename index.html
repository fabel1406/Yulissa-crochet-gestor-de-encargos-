<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Encargos - Yulissa Crochet</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Librería adicional para que funcione el resumen PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #36D1DC;
      --secondary: #5B86E5;
      --accent: #4A90E2;
      /* Paleta de colores suavizada para los estados */
      --status-progress: #f0ad4e; /* Naranja suave */
      --status-completed: #5cb85c; /* Verde suave */
      --status-delivered: #5bc0de; /* Azul cielo suave */
      --success: #5cb85c;
      --warning: #f0ad4e;
      --danger: #d9534f;
      --light: #f8f9fa;
      --dark: #2c3e50;
      --border-radius: 12px;
      --shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); min-height: 100vh; padding: 15px; color: var(--dark); }
    .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.98); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; }
    header { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; padding: 20px; text-align: center; }
    h1 { font-size: 1.8rem; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .app-container { display: flex; flex-direction: column; }
    @media (min-width: 992px) { .app-container { flex-direction: row; } .calendar-section { width: 40%; border-right: 1px solid #eaeaea; } .form-section { width: 60%; } }
    .calendar-section, .form-section { padding: 20px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .calendar-nav { background: var(--accent); color: white; border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; transition: all 0.3s; }
    .calendar-nav:hover { background: var(--secondary); transform: scale(1.05); }
    #monthYear { font-size: 1.2rem; font-weight: 600; text-align: center; flex: 1; }
    .calendar-grid table { width: 100%; border-collapse: collapse; }
    .calendar-grid th { background: rgba(54, 209, 220, 0.15); color: var(--secondary); padding: 10px 5px; text-align: center; font-weight: 600; font-size: 0.85rem; }
    .calendar-grid td { border: 1px solid #eaeaea; padding: 8px 5px; text-align: center; height: 45px; vertical-align: top; cursor: pointer; position: relative; font-size: 0.9rem; transition: background-color 0.2s; }
    .calendar-grid td:hover { background-color: rgba(54, 209, 220, 0.1); }
    .calendar-grid td.has-task { font-weight: 600; color: white; }
    .priority-high { background-color: #e57373; }
    .priority-medium { background-color: #ffb74d; }
    .priority-low { background-color: #81c784; }
    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
    .stat-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 12px 8px; border-radius: var(--border-radius); text-align: center; box-shadow: var(--shadow); }
    .stat-number { font-size: 1.4rem; font-weight: 700; display: block; }
    .stat-label { font-size: 0.7rem; opacity: 0.9; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--secondary); font-size: 0.9rem; }
    input, select, textarea { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: var(--border-radius); font-size: 16px; transition: all 0.3s; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(54, 209, 220, 0.2); }
    .btn { padding: 12px 18px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
    .btn:hover { opacity: 0.9; transform: translateY(-2px); }
    .btn-primary { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; }
    .btn-success { background-color: var(--success); color: white; }
    .btn-info { background-color: var(--status-delivered); color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-danger { background-color: var(--danger); color: white; }
    .btn-warning { background-color: var(--warning); color: white; }
    .task-list { max-height: 400px; overflow-y: auto; margin-top: 20px; border: 1px solid #eee; border-radius: var(--border-radius); padding: 10px; }
    .task-item { background: white; margin-bottom: 12px; padding: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); border-left: 5px solid; transition: all 0.3s; }
    .task-item.status-En-Proceso { border-left-color: var(--status-progress); }
    .task-item.status-Completado { border-left-color: var(--status-completed); }
    .task-item.status-Entregado { border-left-color: var(--status-delivered); }
    .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .task-text { font-weight: 600; }
    .task-details { display: flex; flex-wrap: wrap; gap: 10px; margin: 8px 0; font-size: 0.85rem; color: #666; }
    .task-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
    .btn-small { padding: 6px 10px; font-size: 0.8rem; flex-grow: 1; }
    .filter-buttons { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
    .filter-btn { padding: 10px 15px; background: #f0f0f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; flex: 1; }
    .filter-btn.active { background: var(--primary); color: white; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
    .modal-content { background: white; padding: 25px; border-radius: var(--border-radius); width: 100%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; }
    .close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; background: none; border: none; color: #aaa; }
    .close:hover { color: #333; }
    .today { background-color: rgba(54, 209, 220, 0.2); font-weight: bold; position: relative; }
    .today::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background: var(--primary); border-radius: 50%; }
    .notification-toast { position: fixed; bottom: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; z-index: 1001; transform: translateY(120px); opacity: 0; transition: all 0.4s ease; }
    .notification-toast.show { transform: translateY(0); opacity: 1; }
    .form-error { color: var(--danger); font-size: 0.8rem; margin-top: 5px; display: none; }
    .input-error { border-color: var(--danger) !important; }
    .calendar-grid td.overdue { border: 2px solid var(--danger); }
    .section-title { color: var(--secondary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--primary); display: flex; align-items: center; gap: 10px; }
    .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; color: white; }
    .status-En-Proceso { background-color: var(--status-progress); }
    .status-Completado { background-color: var(--status-completed); }
    .status-Entregado { background-color: var(--status-delivered); }
    .cancel-edit-btn { display: none; }
    .payment-section { background: #f8f9fa; border-radius: var(--border-radius); padding: 15px; margin: 15px 0; }
    .payment-progress { height: 10px; background: #e0e0e0; border-radius: 5px; margin: 10px 0; overflow: hidden; }
    .payment-progress-bar { height: 100%; background: var(--success); border-radius: 5px; transition: width 0.3s; }
    .payment-details { display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.9rem; }
    .payment-actions { display: flex; gap: 10px; margin-top: 10px; }
    #dayOrdersContent { padding-top: 15px; }
    .order-detail-block { border-left: 4px solid var(--primary); padding-left: 15px; margin-bottom: 20px; }
    .order-detail-item { display: grid; grid-template-columns: 80px 1fr; align-items: center; margin-bottom: 10px; font-size: 0.95rem; }
    .order-detail-label { font-weight: 600; color: var(--secondary); }
    .order-detail-value { color: var(--dark); }
  </style>
</head>
<body>
<div class="container">
  <header><h1><i class="fas fa-scroll"></i> Yulissa Crochet</h1><p>Gestor de encargos y pedidos</p></header>
  <div class="app-container">
    <div class="calendar-section">
      <div class="calendar-header">
        <button class="calendar-nav" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
        <span id="monthYear"></span>
        <button class="calendar-nav" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
      </div>
      <div class="calendar-grid"><table id="calendar"><thead><tr><th>Dom</th><th>Lun</th><th>Mar</th><th>Mié</th><th>Jue</th><th>Vie</th><th>Sáb</th></tr></thead><tbody id="calendar-body"></tbody></table></div>
      <div class="stats-row">
        <div class="stat-card"><span class="stat-number" id="totalTasks">0</span><span class="stat-label">Total</span></div>
        <div class="stat-card"><span class="stat-number" id="inProgressTasks">0</span><span class="stat-label">En Proceso</span></div>
        <div class="stat-card"><span class="stat-number" id="completedTasks">0</span><span class="stat-label">Completados</span></div>
      </div>
      <div class="financial-summary">
        <h3 class="section-title"><i class="fas fa-coins"></i> Resumen Financiero</h3>
        <div class="financial-item"><span class="financial-label">Total esperado:</span><span class="financial-value" id="totalExpected">$0</span></div>
        <div class="financial-item"><span class="financial-label">Total recibido:</span><span class="financial-value" id="totalReceived">$0</span></div>
        <div class="financial-item"><span class="financial-label">Pendiente por cobrar:</span><span class="financial-value" id="totalPending">$0</span></div>
      </div>
    </div>
    <div class="form-section">
      <h3 class="section-title"><i class="fas fa-plus-circle"></i> Nuevo Encargo</h3>
      <form id="taskForm">
        <div class="form-group"><label for="clientName">Nombre del cliente</label><input type="text" id="clientName" required><div class="form-error" id="clientNameError"></div></div>
        <div class="form-group"><label for="taskDescription">Descripción del encargo</label><textarea id="taskDescription" rows="3"></textarea><div class="form-error" id="taskDescriptionError"></div></div>
        <div class="form-group"><label for="dueDate">Fecha de entrega</label><input type="date" id="dueDate" required><div class="form-error" id="dueDateError"></div></div>
        <div class="form-group"><label for="orderValue">Valor total del pedido ($)</label><input type="number" id="orderValue" min="0" step="any" required><div class="form-error" id="orderValueError"></div></div>
        <div class="form-group"><label for="priority">Prioridad</label><select id="priority"><option value="low">🟢 Baja</option><option value="medium">🟡 Media</option><option value="high">🔴 Alta</option></select></div>
        <div class="payment-section">
          <h4><i class="fas fa-money-bill-wave"></i> Control de Pagos</h4>
          <div class="form-group"><label for="amountPaid">Monto pagado ($)</label><input type="number" id="amountPaid" min="0" step="any" value="0"><div class="form-error" id="amountPaidError"></div></div>
          <div class="payment-progress"><div class="payment-progress-bar" id="paymentProgressBar" style="width: 0%;"></div></div>
          <div class="payment-details"><span id="paymentPercentage">0%</span><span id="paymentBalance">Saldo: $0</span></div>
          <div class="payment-actions">
            <button type="button" class="btn btn-small btn-success" id="addPaymentBtn"><i class="fas fa-plus"></i> Agregar Pago</button>
          </div>
        </div>
        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar Encargo</button>
        <button type="button" id="cancelEditBtn" class="btn btn-secondary cancel-edit-btn"><i class="fas fa-times"></i> Cancelar Edición</button>
      </form>
      <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all">Todos</button>
        <button class="filter-btn" data-filter="inProgress">En Proceso</button>
        <button class="filter-btn" data-filter="completed">Completados</button>
        <button class="filter-btn" data-filter="overdue">Vencidos</button>
        <button class="filter-btn" data-filter="unpaid">Por Pagar</button>
      </div>
      <h3 class="section-title"><i class="fas fa-list"></i> Lista de Encargos</h3>
      <input type="text" id="searchInput" placeholder="🔍 Buscar encargos..." class="form-group">
      <div class="task-list" id="taskList"><div class="empty-state"><i class="fas fa-clipboard-list"></i><p>No hay encargos registrados</p></div></div>
      <div class="btn-group">
        <button id="exportBtn" class="btn btn-warning"><i class="fas fa-file-pdf"></i> Exportar Resumen</button>
        <button id="clearAllBtn" class="btn btn-danger"><i class="fas fa-trash"></i> Limpiar Todo</button>
      </div>
    </div>
  </div>
</div>
<div id="dayDetailsModal" class="modal"><div class="modal-content"><button class="close" id="closeDayDetails">&times;</button><h2><i class="fas fa-calendar-day"></i> Encargos del <span id="modalDate"></span></h2><div id="dayOrdersContent"></div></div></div>
<div id="addPaymentModal" class="modal"><div class="modal-content"><button class="close" id="closeAddPayment">&times;</button><h2><i class="fas fa-money-bill-wave"></i> Agregar Abono</h2><div class="form-group"><label for="paymentAmount">Monto a abonar ($)</label><input type="number" id="paymentAmount" min="0" step="any"><div class="form-error" id="paymentAmountError"></div></div><button id="confirmPaymentBtn" class="btn btn-success"><i class="fas fa-check"></i> Confirmar</button></div></div>
<div class="notification-toast" id="notification"><span id="notification-message"></span></div>

<script>
let orders = [];
let currentDate = new Date();
let currentFilter = 'all';
let editingIndex = -1;

document.addEventListener('DOMContentLoaded', () => {
  if (!isStorageAvailable('localStorage')) {
    showNotification("Tu navegador no es compatible con el guardado local.", "error");
    return;
  }
  loadOrders();
  setupEventListeners();
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dueDate').min = today;
  document.getElementById('dueDate').value = today;
  updateAllUI();
});

function isStorageAvailable(type) { try { const storage = window[type], x = '__storage_test__'; storage.setItem(x, x); storage.removeItem(x); return true; } catch (e) { return false; } }
function loadOrders() { const saved = localStorage.getItem('yulissa_orders'); orders = saved ? JSON.parse(saved).map(o => ({...o, status: o.status || 'En Proceso'})) : []; }
function saveOrders() { localStorage.setItem('yulissa_orders', JSON.stringify(orders)); }

function setupEventListeners() {
  document.getElementById('taskForm').addEventListener('submit', handleFormSubmit);
  document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', function() {
    document.querySelector('.filter-btn.active').classList.remove('active'); this.classList.add('active'); currentFilter = this.dataset.filter; renderOrderList();
  }));
  document.getElementById('searchInput').addEventListener('input', renderOrderList);
  document.getElementById('prevBtn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
  document.getElementById('nextBtn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
  document.getElementById('cancelEditBtn').addEventListener('click', resetForm);
  document.getElementById('exportBtn').addEventListener('click', exportSummaryToPDF);
  document.getElementById('clearAllBtn').addEventListener('click', clearAllOrders);
  document.getElementById('orderValue').addEventListener('input', updatePaymentProgress);
  document.getElementById('amountPaid').addEventListener('input', updatePaymentProgress);
  document.getElementById('addPaymentBtn').addEventListener('click', openAddPaymentModal);
  document.getElementById('confirmPaymentBtn').addEventListener('click', confirmPayment);
  document.getElementById('closeDayDetails').addEventListener('click', () => toggleModal('dayDetailsModal', false));
  document.getElementById('closeAddPayment').addEventListener('click', () => toggleModal('addPaymentModal', false));
}

function handleFormSubmit(e) {
  e.preventDefault();
  if (!validateForm()) return showNotification("Por favor, corrige los errores.", "error");
  const orderData = {
    clientName: document.getElementById('clientName').value.trim(),
    taskDescription: document.getElementById('taskDescription').value.trim(),
    dueDate: document.getElementById('dueDate').value,
    orderValue: Number(document.getElementById('orderValue').value) || 0,
    amountPaid: Number(document.getElementById('amountPaid').value) || 0,
    priority: document.getElementById('priority').value,
    status: editingIndex > -1 ? orders[editingIndex].status : 'En Proceso',
    updatedAt: new Date().toISOString()
  };
  if (editingIndex === -1) {
    orderData.createdAt = new Date().toISOString(); orders.push(orderData); showNotification('Encargo guardado.', 'success');
  } else {
    orderData.createdAt = orders[editingIndex].createdAt; orders[editingIndex] = orderData; showNotification('Encargo actualizado.', 'success');
  }
  saveOrders(); updateAllUI(); resetForm();
}

function editOrder(index) {
  const order = orders[index]; if (!order) return;
  document.getElementById('clientName').value = order.clientName;
  document.getElementById('taskDescription').value = order.taskDescription;
  document.getElementById('dueDate').value = order.dueDate;
  document.getElementById('orderValue').value = order.orderValue;
  document.getElementById('amountPaid').value = order.amountPaid;
  document.getElementById('priority').value = order.priority;
  editingIndex = index;
  document.getElementById('cancelEditBtn').style.display = 'block';
  document.querySelector('.btn-primary').innerHTML = '<i class="fas fa-save"></i> Actualizar Encargo';
  document.getElementById('taskForm').scrollIntoView({ behavior: 'smooth' });
}

function deleteOrder(index) { if (confirm('¿Seguro que quieres eliminar este encargo?')) { orders.splice(index, 1); saveOrders(); updateAllUI(); showNotification('Encargo eliminado.', 'error'); } }
function changeStatus(index, newStatus) { if (orders[index]) { orders[index].status = newStatus; saveOrders(); updateAllUI(); showNotification(`Estado cambiado a: ${newStatus}`, 'success'); } }

function resetForm() {
  document.getElementById('taskForm').reset();
  document.getElementById('dueDate').value = new Date().toISOString().split('T')[0];
  editingIndex = -1;
  document.getElementById('cancelEditBtn').style.display = 'none';
  document.querySelector('.btn-primary').innerHTML = '<i class="fas fa-save"></i> Guardar Encargo';
  updatePaymentProgress();
}

function validateForm() {
    let isValid = true;
    const validations = [
        { id: 'clientName', condition: val => val.trim() !== '', msg: "Ingresa un nombre" },
        { id: 'taskDescription', condition: val => val.trim() !== '', msg: "Ingresa una descripción" },
        { id: 'dueDate', condition: val => val, msg: "Selecciona una fecha" },
        { id: 'orderValue', condition: val => Number(val) > 0, msg: "El valor debe ser mayor a 0" },
    ];
    validations.forEach(({ id, condition, msg }) => {
        const el = document.getElementById(id);
        if (!validateField(el, `${id}Error`, condition(el.value), msg)) isValid = false;
    });
    return isValid;
}

function validateField(field, errorId, condition, message) {
  const errorEl = document.getElementById(errorId);
  if (condition) { field.classList.remove('input-error'); errorEl.style.display = 'none'; return true; }
  field.classList.add('input-error'); errorEl.textContent = message; errorEl.style.display = 'block'; return false;
}

function updatePaymentProgress() {
  const orderValue = Number(document.getElementById('orderValue')?.value) || 0;
  const amountPaid = Number(document.getElementById('amountPaid')?.value) || 0;
  const percentage = orderValue > 0 ? Math.min(100, (amountPaid / orderValue) * 100) : 0;
  const balance = Math.max(0, orderValue - amountPaid);
  document.getElementById('paymentProgressBar').style.width = `${percentage}%`;
  document.getElementById('paymentPercentage').textContent = `${percentage.toFixed(0)}%`;
  document.getElementById('paymentBalance').textContent = `Saldo: ${formatCurrency(balance)}`;
}

function openAddPaymentModal() {
    const orderValue = Number(document.getElementById('orderValue').value) || 0;
    const amountPaid = Number(document.getElementById('amountPaid').value) || 0;
    if (amountPaid >= orderValue) return showNotification("Este pedido ya está pagado.", "warning");
    toggleModal('addPaymentModal', true);
}

function confirmPayment() {
    const amountToAdd = Number(document.getElementById('paymentAmount').value) || 0;
    const amountPaidEl = document.getElementById('amountPaid');
    const currentPaid = Number(amountPaidEl.value) || 0;
    const totalValue = Number(document.getElementById('orderValue').value) || 0;

    if (amountToAdd <= 0) return showNotification("Ingresa un monto válido.", "error");
    if (currentPaid + amountToAdd > totalValue) return showNotification("El abono supera el valor total del pedido.", "error");
    
    amountPaidEl.value = currentPaid + amountToAdd;
    updatePaymentProgress();
    toggleModal('addPaymentModal', false);
    document.getElementById('paymentAmount').value = '';
    showNotification("Abono registrado.", "success");
}

function updateAllUI() { renderCalendar(); updateStats(); updateFinancialSummary(); renderOrderList(); }

function renderCalendar() {
    const calendarBody = document.getElementById('calendar-body');
    const monthYear = document.getElementById('monthYear');
    calendarBody.innerHTML = '';
    monthYear.textContent = `${currentDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}`;
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
    let date = 1;
    for (let i = 0; i < 6 && date <= daysInMonth; i++) {
        let row = calendarBody.insertRow();
        for (let j = 0; j < 7; j++) {
            let cell = row.insertCell();
            if (i === 0 && j < firstDay.getDay() || date > daysInMonth) continue;
            cell.textContent = date;
            const cellDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), date);
            const dateString = formatDate(cellDate);
            const dayOrders = orders.filter(o => o.dueDate === dateString);
            if (dayOrders.length > 0) {
                cell.classList.add('has-task');
                if (dayOrders.some(o => o.priority === 'high')) cell.classList.add('priority-high');
                else if (dayOrders.some(o => o.priority === 'medium')) cell.classList.add('priority-medium');
                else cell.classList.add('priority-low');
                if (dateString < formatDate(new Date()) && dayOrders.some(o => o.status === 'En Proceso')) cell.classList.add('overdue');
                cell.dataset.date = dateString;
                cell.addEventListener('click', () => showDayDetails(dateString));
            }
            if (new Date().toDateString() === cellDate.toDateString()) cell.classList.add('today');
            date++;
        }
    }
}

function renderOrderList() {
    const taskList = document.getElementById('taskList');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const today = formatDate(new Date());
    let filtered = orders;
    if (currentFilter === 'inProgress') filtered = orders.filter(o => o.status === 'En Proceso');
    else if (currentFilter === 'completed') filtered = orders.filter(o => o.status === 'Completado' || o.status === 'Entregado');
    else if (currentFilter === 'overdue') filtered = orders.filter(o => o.status === 'En Proceso' && o.dueDate < today);
    else if (currentFilter === 'unpaid') filtered = orders.filter(o => o.amountPaid < o.orderValue);
    if (searchTerm) filtered = filtered.filter(o => o.clientName.toLowerCase().includes(searchTerm) || o.taskDescription.toLowerCase().includes(searchTerm));
    filtered.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
    
    taskList.innerHTML = '';
    if (filtered.length === 0) {
        taskList.innerHTML = `<div class="empty-state" style="padding: 40px 20px;"><i class="fas fa-clipboard-list" style="font-size: 3rem; color: #ccc;"></i><p style="color: #888;">No hay encargos que mostrar.</p></div>`;
        return;
    }

    filtered.forEach(order => {
        const index = orders.indexOf(order);
        const el = document.createElement('div');
        el.className = `task-item status-${order.status.replace(' ', '-')}`;
        el.innerHTML = `
            <div class="task-header">
                <span class="task-text">${escapeHtml(order.clientName)}</span>
                <span class="status-badge status-${order.status}">${order.status}</span>
            </div>
            <p style="font-size: 0.9rem; color: #555;">${escapeHtml(order.taskDescription)}</p>
            <div class="task-details">
                <span>🗓️ Entrega: ${formatDisplayDate(order.dueDate)}</span>
                <span>💰 Pagado: ${formatCurrency(order.amountPaid)} / ${formatCurrency(order.orderValue)}</span>
            </div>
            <div class="task-actions">
                ${order.status === 'En Proceso' ? `<button class="btn btn-small btn-success" onclick="changeStatus(${index}, 'Completado')"><i class="fas fa-check"></i> Completar</button>` : ''}
                ${order.status === 'Completado' ? `<button class="btn btn-small btn-info" onclick="changeStatus(${index}, 'Entregado')"><i class="fas fa-truck"></i> Entregar</button>` : ''}
                ${order.status !== 'En Proceso' ? `<button class="btn btn-small btn-warning" onclick="changeStatus(${index}, 'En Proceso')"><i class="fas fa-undo"></i> Reactivar</button>` : ''}
                <button class="btn btn-small btn-secondary" onclick="editOrder(${index})"><i class="fas fa-edit"></i> Editar</button>
                <button class="btn btn-small btn-primary" onclick="generateInvoice(${index})"><i class="fas fa-file-invoice"></i> Factura</button>
            </div>`;
        taskList.appendChild(el);
    });
}

function updateStats() {
  document.getElementById('totalTasks').textContent = orders.length;
  document.getElementById('inProgressTasks').textContent = orders.filter(o => o.status === 'En Proceso').length;
  document.getElementById('completedTasks').textContent = orders.filter(o => o.status === 'Completado' || o.status === 'Entregado').length;
}

function updateFinancialSummary() {
  const totalExpected = orders.reduce((sum, o) => sum + (Number(o.orderValue) || 0), 0);
  const totalReceived = orders.reduce((sum, o) => sum + (Number(o.amountPaid) || 0), 0);
  document.getElementById('totalExpected').textContent = `${formatCurrency(totalExpected)}`;
  document.getElementById('totalReceived').textContent = `${formatCurrency(totalReceived)}`;
  document.getElementById('totalPending').textContent = `${formatCurrency(totalExpected - totalReceived)}`;
}

function showDayDetails(dateString) {
    const dayOrders = orders.filter(o => o.dueDate === dateString);
    document.getElementById('modalDate').textContent = formatDisplayDate(dateString);
    const contentEl = document.getElementById('dayOrdersContent');
    if (dayOrders.length === 0) {
        contentEl.innerHTML = '<p style="text-align: center; color: #777;">No hay encargos programados para este día.</p>';
    } else {
        contentEl.innerHTML = dayOrders.map(order => {
            const paymentPercentage = order.orderValue > 0 ? (order.amountPaid / order.orderValue) * 100 : 0;
            return `
              <div class="order-detail-block">
                <div class="order-detail-item"><span class="order-detail-label">Cliente:</span><span class="order-detail-value">${escapeHtml(order.clientName)}</span></div>
                <div class="order-detail-item"><span class="order-detail-label">Encargo:</span><span class="order-detail-value">${escapeHtml(order.taskDescription)}</span></div>
                <div class="order-detail-item"><span class="order-detail-label">Valor:</span><span class="order-detail-value">${formatCurrency(order.orderValue)} (${paymentPercentage.toFixed(0)}% pagado)</span></div>
                <div class="order-detail-item"><span class="order-detail-label">Estado:</span><span class="order-detail-value">${order.status}</span></div>
              </div>`;
        }).join('');
    }
    toggleModal('dayDetailsModal', true);
}

function toggleModal(id, show) { document.getElementById(id).style.display = show ? 'flex' : 'none'; }
function showNotification(message, type = 'success') {
  const el = document.getElementById('notification');
  el.querySelector('#notification-message').textContent = message;
  el.className = `notification-toast show ${type}`;
  setTimeout(() => el.className = 'notification-toast', 3000);
}

function clearAllOrders() {
    if(confirm('¿ESTÁS SEGURO? Esta acción borrará TODOS los encargos permanentemente.')) {
        orders = []; saveOrders(); updateAllUI(); showNotification('Todos los encargos han sido eliminados.', 'error');
    }
}

function generateInvoice(index) {
    const order = orders[index]; if (!order || typeof window.jspdf?.jsPDF === 'undefined') return showNotification("Error al generar factura.", "error");
    const { jsPDF } = window.jspdf; const doc = new jsPDF();
    
    doc.setFontSize(22).setFont(undefined, 'bold').text('Yulissa Crochet', 20, 30);
    doc.setFontSize(12).setFont(undefined, 'normal').text('Factura de Encargo', 20, 38);
    doc.setFontSize(11).setFont(undefined, 'bold').text('Cliente:', 20, 55); doc.setFont(undefined, 'normal').text(sanitizeForPDF(order.clientName), 40, 55);
    doc.setFont(undefined, 'bold').text('Fecha:', 140, 55); doc.setFont(undefined, 'normal').text(new Date().toLocaleDateString('es-ES'), 155, 55);
    doc.line(20, 65, 190, 65);
    doc.setFontSize(14).setFont(undefined, 'bold').text('Descripción del Encargo', 20, 75);
    doc.setFontSize(12).setFont(undefined, 'normal').text(doc.splitTextToSize(sanitizeForPDF(order.taskDescription), 170), 20, 85);

    let finalY = 150;
    const labelX = 130;
    const valueX = 190;
    doc.setFontSize(12);

    doc.setFont(undefined, 'bold').text('Valor Total:', labelX, finalY, { align: 'left' });
    doc.setFont(undefined, 'normal').text(`${formatCurrency(order.orderValue)}`, valueX, finalY, { align: 'right' });

    doc.setFont(undefined, 'bold').text('Monto Pagado:', labelX, finalY + 10, { align: 'left' });
    doc.setFont(undefined, 'normal').text(`${formatCurrency(order.amountPaid)}`, valueX, finalY + 10, { align: 'right' });

    doc.line(labelX, finalY + 15, valueX, finalY + 15);

    doc.setFont(undefined, 'bold').text('Saldo Pendiente:', labelX, finalY + 22, { align: 'left' });
    doc.setFont(undefined, 'normal').text(`${formatCurrency(order.orderValue - order.amountPaid)}`, valueX, finalY + 22, { align: 'right' });

    doc.setFontSize(10).setTextColor(150).text('¡Gracias por tu compra!', 105, 270, { align: 'center' });
    doc.save(`factura-${sanitizeForPDF(order.clientName).replace(/\s/g, '_')}-${order.dueDate}.pdf`);
    showNotification('Factura generada.', 'success');
}

function exportSummaryToPDF() {
    if (typeof jspdf.jsPDF.API.autoTable === 'undefined') {
        return showNotification("Error: La librería para exportar tablas PDF no está cargada.", "error");
    }
    const { jsPDF } = window.jspdf; const doc = new jsPDF();
    doc.setFontSize(18).text('Resumen de Encargos - Yulissa Crochet', 14, 22);
    const tableData = orders.map(o => [ o.clientName, formatDisplayDate(o.dueDate), o.status, formatCurrency(o.orderValue) ]);
    doc.autoTable({ head: [['Cliente', 'Fecha Entrega', 'Estado', 'Valor']], body: tableData, startY: 30 });
    doc.save(`resumen-encargos-${formatDate(new Date())}.pdf`);
}

function formatDate(date) { return date.toISOString().split('T')[0]; }
function formatDisplayDate(dateString) { return new Date(dateString + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
function formatCurrency(amount) { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount || 0); }
function escapeHtml(unsafe) { return (unsafe || '').toString().replace(/[&<"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); }
function sanitizeForPDF(text) { return (text || '').toString().replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '').trim(); }
</script>

</body>
</html>
